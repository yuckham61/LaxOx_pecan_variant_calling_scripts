#!/bin/bash
#SBATCH --job-name=variantcalling_run
#SBATCH --partition=batch
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=40
#SBATCH --mem=32G
#SBATCH --time=04:00:00
#SBATCH --output=logs/%x_%j.out
#SBATCH --error=logs/%x_%j.err


set -e  #Stop scripts if command fails

# Set the URL of the genome FASTA
#genome_url="ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/016/808/215/GCA_016808215.1_C.illinoinensisOaxaca_v1/GCA_016808215.1_C.illinoinensisOaxaca_v1_genomic.fna.gz"


#To download the genome from the url
#wget -O data/genomes/C_illinoinensisOaxaca_genomic.fna.gz $genome_url

# Decompress the genome
#gunzip data/genomes/C_illinoinensisOaxaca_genomic.fna.gz

# Make folder
#mkdir data/genomes
mkdir -p results/re_sam
mkdir -p logs
mkdir -p results/bam

# Load all the required modules

# Load BWA
#module load BWA/0.7.18-GCCcore-13.3.0

# Load SAMtools
module load SAMtools/1.21-GCC-13.3.0


# Index the complete genome of C_illinoinensisOaxaca_genomics
#bwa index data/genomes/C_illinoinensisOaxaca_genomic.fna

# After indexing, allignment needs to be done
for file in raw_data/*.txt.trimmed_seqs.txt
do

#Remove path and suffix to get clean output files
sample=$(basename "$file" .txt.trimmed_seqs.txt)

echo "processing $sample"

#bwa mem -t 40 data/genomes/C_illinoinensisOaxaca_genomic.fna "$file" > results/re_sam/${sample}.sam

# Convert sam file to bam file
#samtools view -@40 -S -b results/re_sam/$sample.sam > results/bam/$sample.bam

# Sorting the bam files for indexing and visualization
#samtools sort -@40 results/bam/${sample}.bam -o results/bam/${sample}.sorted.bam

# Indexing the sorted bam files
samtools index results/bam/${sample}.sorted.bam

#Generate bcf file
bcftools mpileup -O b -o results/bcf/${sample}.bcf -f data/genomes/C_illinoinensisOaxaca_genomic.fna results/bam/${sample}.sorted.bam



done 



